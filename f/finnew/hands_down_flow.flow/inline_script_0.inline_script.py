import pandas as pd
import openpyxl
from openpyxl.styles import Font, PatternFill, Alignment, Border, Side
from openpyxl.utils import get_column_letter
import os
import re
import io
import boto3
from typing import Dict, Any, Optional
import tempfile


def main(
    aws_access_key_id: str,
    aws_secret_access_key: str,
    input_s3_bucket: str,
    input_s3_key: str,
    output_s3_bucket: str,
    s3_region: str = None,
) -> Dict[str, Any]:
    """
    Convert CSV file from S3 to Excel XLSX with VPBank Securities formatting and upload back to S3

    Args:
        s3_resource: AWS S3 credentials and configuration
        input_s3_bucket: S3 bucket containing the input CSV file
        input_s3_key: S3 key (path) to the input CSV file
        output_s3_bucket: S3 bucket for the output Excel file
        output_s3_key: S3 key (path) for the output Excel file (optional, auto-generated if not provided)

    Returns:
        Dict containing conversion results and S3 paths
    """

    try:
        # T·∫°o S3 client
        s3_client = boto3.client(
            "s3",
            aws_access_key_id="aws_access_key_id",
            aws_secret_access_key="aws_secret_access_key",
            region_name=s3_region,
        )

        # L·∫•y t√™n file t·ª´ input key v√† ƒë·ªïi extension
        base_name = os.path.splitext(os.path.basename(input_s3_key))[0]
        output_s3_key = f"{base_name}.xlsx"

        # T·∫°o temporary file ƒë·ªÉ download CSV t·ª´ S3
        with tempfile.NamedTemporaryFile(
            mode="w+", suffix=".csv", delete=False, encoding="utf-8"
        ) as temp_csv:
            temp_csv_path = temp_csv.name

        # Download CSV file t·ª´ S3
        print(f"üì• Downloading CSV from s3://{input_s3_bucket}/{input_s3_key}")
        s3_client.download_file(input_s3_bucket, input_s3_key, temp_csv_path)

        # ƒê·ªçc v√† x·ª≠ l√Ω file CSV
        with open(temp_csv_path, "r", encoding="utf-8") as file:
            lines = file.readlines()

        # X·ª≠ l√Ω d·ªØ li·ªáu
        data_sections = []
        current_section = []
        title_row = None

        for i, line in enumerate(lines):
            line = line.strip()
            if not line:
                if current_section:
                    data_sections.append(current_section)
                    current_section = []
                continue

            # D√≤ng ƒë·∫ßu ti√™n l√† ti√™u ƒë·ªÅ
            if i == 0:
                title_row = line
                continue

            current_section.append(line)

        # Th√™m section cu·ªëi n·∫øu c√≥
        if current_section:
            data_sections.append(current_section)

        # T·∫°o workbook Excel
        wb = openpyxl.Workbook()
        ws = wb.active
        ws.title = "Stock Summary"

        # ƒê·ªãnh nghƒ©a m√†u s·∫Øc theo VPBank Securities
        colors = {
            "title_bg": "4CAF50",  # Xanh VPBank cho ti√™u ƒë·ªÅ
            "title_text": "FFFFFF",  # Tr·∫Øng cho text ti√™u ƒë·ªÅ
            "header_bg": "43A047",  # Xanh ƒë·∫≠m VPBank cho header
            "header_text": "FFFFFF",  # Tr·∫Øng cho text header
            "increase": "4CAF50",  # Xanh l√° VPBank cho tƒÉng
            "decrease": "FF0000",  # ƒê·ªè cho gi·∫£m
            "neutral": "000000",  # ƒêen cho trung t√≠nh
            "special_bg": "E8F5E8",  # Xanh nh·∫°t VPBank cho background
            "vpbank_green": "43A047",  # Xanh ƒë·∫≠m VPBank
        }

        current_row = 1

        # Th√™m ti√™u ƒë·ªÅ
        if title_row:
            ws.merge_cells(f"A{current_row}:G{current_row}")
            cell = ws[f"A{current_row}"]
            cell.value = title_row
            cell.font = Font(
                name="Times New Roman", bold=True, size=14, color=colors["title_text"]
            )
            cell.fill = PatternFill(
                start_color=colors["title_bg"],
                end_color=colors["title_bg"],
                fill_type="solid",
            )
            cell.alignment = Alignment(horizontal="center", vertical="center")
            ws.row_dimensions[current_row].height = 30
            current_row += 1

        # X·ª≠ l√Ω t·ª´ng section
        for section in data_sections:
            if not section:
                continue

            first_line = section[0]

            # Ki·ªÉm tra n·∫øu l√† section ch·ªâ s·ªë ch·ª©ng kho√°n (c√≥ header)
            if "CH·ªà S·ªê" in first_line and "ƒêI·ªÇM" in first_line:
                # T·∫°o header
                headers = [
                    "CH·ªà S·ªê",
                    "ƒêI·ªÇM",
                    "(+/-)",
                    "(+/- %)",
                    "KLGD( tri·ªáu cp)",
                    "GTGD ( t·ª∑)",
                    "CP tƒÉng/gi·∫£m",
                ]

                for col_idx, header in enumerate(headers, 1):
                    cell = ws.cell(row=current_row, column=col_idx, value=header)
                    cell.font = Font(
                        name="Times New Roman",
                        bold=True,
                        size=11,
                        color=colors["header_text"],
                    )
                    cell.fill = PatternFill(
                        start_color=colors["header_bg"],
                        end_color=colors["header_bg"],
                        fill_type="solid",
                    )
                    cell.alignment = Alignment(horizontal="center", vertical="center")

                ws.row_dimensions[current_row].height = 25
                current_row += 1

                # X·ª≠ l√Ω d·ªØ li·ªáu ch·ªâ s·ªë
                for line in section[1:]:
                    if not line.strip():
                        continue

                    # Parse d√≤ng d·ªØ li·ªáu ch·ªâ s·ªë
                    parts = line.split(",")
                    if len(parts) >= 6:
                        # T√™n ch·ªâ s·ªë
                        cell = ws.cell(row=current_row, column=1, value=parts[0])
                        cell.font = Font(
                            name="Times New Roman",
                            bold=True,
                            size=11,
                            color=colors["decrease"],
                        )
                        cell.alignment = Alignment(horizontal="left", vertical="center")

                        # ƒêi·ªÉm
                        cell = ws.cell(row=current_row, column=2, value=parts[1])
                        cell.font = Font(
                            name="Times New Roman", size=11, color=colors["decrease"]
                        )
                        cell.alignment = Alignment(
                            horizontal="right", vertical="center"
                        )

                        # (+/-)
                        change_val = parts[2]
                        cell = ws.cell(row=current_row, column=3, value=change_val)
                        if "-" in change_val:
                            cell.font = Font(
                                name="Times New Roman",
                                size=11,
                                color=colors["decrease"],
                            )
                        else:
                            cell.font = Font(
                                name="Times New Roman",
                                size=11,
                                color=colors["increase"],
                            )
                        cell.alignment = Alignment(
                            horizontal="right", vertical="center"
                        )

                        # (+/- %)
                        percent_val = parts[3]
                        cell = ws.cell(row=current_row, column=4, value=percent_val)
                        if "-" in percent_val:
                            cell.font = Font(
                                name="Times New Roman",
                                size=11,
                                color=colors["decrease"],
                            )
                        else:
                            cell.font = Font(
                                name="Times New Roman",
                                size=11,
                                color=colors["increase"],
                            )
                        cell.alignment = Alignment(
                            horizontal="right", vertical="center"
                        )

                        # KLGD
                        cell = ws.cell(row=current_row, column=5, value=parts[4])
                        cell.font = Font(name="Times New Roman", size=11)
                        cell.alignment = Alignment(
                            horizontal="right", vertical="center"
                        )

                        # GTGD
                        cell = ws.cell(row=current_row, column=6, value=parts[5])
                        cell.font = Font(name="Times New Roman", size=11)
                        cell.alignment = Alignment(
                            horizontal="right", vertical="center"
                        )

                        # CP tƒÉng/gi·∫£m
                        if len(parts) > 6:
                            cp_change = parts[6]
                            cell = ws.cell(row=current_row, column=7, value=cp_change)

                            # T√°ch v√† t√¥ m√†u t·ª´ng ph·∫ßn
                            if "|" in cp_change:
                                # Format: 69|33|263 -> 69 xanh, 33 ƒëen, 263 ƒë·ªè
                                parts_cp = cp_change.split("|")
                                formatted_text = (
                                    f"{parts_cp[0]}|{parts_cp[1]}|{parts_cp[2]}"
                                )
                                cell.value = formatted_text
                                cell.font = Font(name="Times New Roman", size=11)
                            else:
                                cell.font = Font(name="Times New Roman", size=11)
                            cell.alignment = Alignment(
                                horizontal="center", vertical="center"
                            )

                        ws.row_dimensions[current_row].height = 25
                        current_row += 1

            else:
                # C√°c section kh√°c (Kh·ªëi ngo·∫°i, Top mua r√≤ng, etc.)
                for line in section:
                    if not line.strip():
                        continue

                    # L√†m s·∫°ch d·ªØ li·ªáu: b·ªè d·∫•u ph·∫©y v√† ngo·∫∑c k√©p
                    cleaned_line = line.replace('"', "").replace(",", " ")

                    # Merge to√†n b·ªô d√≤ng
                    ws.merge_cells(f"A{current_row}:G{current_row}")
                    cell = ws[f"A{current_row}"]
                    cell.value = cleaned_line

                    # X√°c ƒë·ªãnh m√†u d·ª±a tr√™n n·ªôi dung v·ªõi m√†u VPBank
                    if "Kh·ªëi ngo·∫°i" in line:
                        if "+" in line:
                            cell.font = Font(
                                name="Times New Roman",
                                bold=True,
                                size=11,
                                color=colors["increase"],
                            )
                        else:
                            cell.font = Font(
                                name="Times New Roman",
                                bold=True,
                                size=11,
                                color=colors["decrease"],
                            )
                        cell.fill = PatternFill(
                            start_color=colors["special_bg"],
                            end_color=colors["special_bg"],
                            fill_type="solid",
                        )
                    elif "Top mua r√≤ng" in line:
                        cell.font = Font(
                            name="Times New Roman",
                            bold=True,
                            size=11,
                            color=colors["increase"],
                        )
                        cell.fill = PatternFill(
                            start_color=colors["special_bg"],
                            end_color=colors["special_bg"],
                            fill_type="solid",
                        )
                    elif "Top b√°n r√≤ng" in line:
                        cell.font = Font(
                            name="Times New Roman",
                            bold=True,
                            size=11,
                            color=colors["decrease"],
                        )
                    elif "Kh·ªëi t·ª± doanh" in line:
                        if "+" in line:
                            cell.font = Font(
                                name="Times New Roman",
                                bold=True,
                                size=11,
                                color=colors["increase"],
                            )
                        else:
                            cell.font = Font(
                                name="Times New Roman",
                                bold=True,
                                size=11,
                                color=colors["decrease"],
                            )
                        cell.fill = PatternFill(
                            start_color=colors["special_bg"],
                            end_color=colors["special_bg"],
                            fill_type="solid",
                        )
                    elif "Nh√≥m ng√†nh" in line:
                        cell.font = Font(
                            name="Times New Roman", size=11, color=colors["neutral"]
                        )
                        cell.fill = PatternFill(
                            start_color=colors["special_bg"],
                            end_color=colors["special_bg"],
                            fill_type="solid",
                        )
                    elif "C·ªï phi·∫øu" in line:
                        cell.font = Font(
                            name="Times New Roman", size=11, color=colors["neutral"]
                        )
                    elif "T√°c ƒë·ªông tƒÉng" in line:
                        cell.font = Font(
                            name="Times New Roman", size=11, color=colors["increase"]
                        )
                    elif "T√°c ƒë·ªông gi·∫£m" in line:
                        cell.font = Font(
                            name="Times New Roman", size=11, color=colors["decrease"]
                        )
                    else:
                        cell.font = Font(
                            name="Times New Roman", size=11, color=colors["neutral"]
                        )

                    cell.alignment = Alignment(horizontal="left", vertical="center")
                    ws.row_dimensions[current_row].height = 25
                    current_row += 1

        # Th√™m border cho to√†n b·ªô b·∫£ng
        thin_border = Border(
            left=Side(style="thin"),
            right=Side(style="thin"),
            top=Side(style="thin"),
            bottom=Side(style="thin"),
        )

        for row in ws.iter_rows(
            min_row=1, max_row=current_row - 1, min_col=1, max_col=7
        ):
            for cell in row:
                cell.border = thin_border

        # ƒêi·ªÅu ch·ªânh ƒë·ªô r·ªông c·ªôt
        column_widths = [15, 12, 10, 10, 18, 15, 20]  # ƒê·ªô r·ªông t√πy ch·ªânh cho t·ª´ng c·ªôt
        for i, width in enumerate(column_widths, 1):
            ws.column_dimensions[get_column_letter(i)].width = width

        # T·∫°o temporary file ƒë·ªÉ l∆∞u Excel
        with tempfile.NamedTemporaryFile(
            mode="w+b", suffix=".xlsx", delete=False
        ) as temp_excel:
            temp_excel_path = temp_excel.name

        # L∆∞u Excel file
        wb.save(temp_excel_path)

        # Upload Excel file l√™n S3
        print(f"üì§ Uploading Excel to s3://{output_s3_bucket}/{output_s3_key}")
        s3_client.upload_file(temp_excel_path, output_s3_bucket, output_s3_key)

        # L·∫•y file size
        file_size = os.path.getsize(temp_excel_path)

        # Cleanup temporary files
        os.unlink(temp_csv_path)
        os.unlink(temp_excel_path)

        return {
            "success": True,
            "message": "‚úÖ CSV ƒë√£ ƒë∆∞·ª£c convert th√†nh c√¥ng sang Excel v√† upload l√™n S3!",
            "input_s3_path": f"s3://{input_s3_bucket}/{input_s3_key}",
            "output_s3_path": f"s3://{output_s3_bucket}/{output_s3_key}",
            "output_s3_bucket": output_s3_bucket,
            "output_s3_key": output_s3_key,
            "rows_processed": current_row - 1,
            "file_size_bytes": file_size,
            "formatting": {
                "title_background": colors["title_bg"],
                "header_background": colors["header_bg"],
                "font": "Times New Roman",
                "vpbank_style": True,
            },
        }

    except Exception as e:
        return {
            "success": False,
            "error": f"‚ùå L·ªói khi convert file: {str(e)}",
            "message": "Vui l√≤ng ki·ªÉm tra l·∫°i ƒë∆∞·ªùng d·∫´n S3 v√† quy·ªÅn truy c·∫≠p",
            "input_s3_path": f"s3://{input_s3_bucket}/{input_s3_key}",
            "output_s3_path": None,
        }


def validate_s3_paths(
    s3_resource: dict, input_bucket: str, input_key: str, output_bucket: str
) -> Dict[str, Any]:
    """
    Validate S3 paths and permissions before processing
    """
    try:
        s3_client = boto3.client(
            "s3",
            aws_access_key_id="aws_access_key_id",
            aws_secret_access_key="aws_secret_access_key",
            region_name=s3_resource.get("region", "us-east-1"),
        )

        # Check if input file exists
        try:
            s3_client.head_object(Bucket=input_bucket, Key=input_key)
            input_exists = True
        except:
            input_exists = False

        # Check if output bucket exists
        try:
            s3_client.head_bucket(Bucket=output_bucket)
            output_bucket_exists = True
        except:
            output_bucket_exists = False

        return {
            "input_file_exists": input_exists,
            "output_bucket_exists": output_bucket_exists,
            "validation_passed": input_exists and output_bucket_exists,
            "input_s3_path": f"s3://{input_bucket}/{input_key}",
            "output_s3_bucket": f"s3://{output_bucket}",
        }

    except Exception as e:
        return {"validation_passed": False, "error": str(e)}
